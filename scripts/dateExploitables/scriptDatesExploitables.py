#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Thu Aug 12 17:12:53 2021

@author: Emilie SIROT
"""

import os
from osgeo import gdal
import itertools
import rasterio
import numpy as np 
import geopandas as gpd
import pandas as pd


####################
####################
### Tuile 31TFJ ####
####################
####################
 
 
repDonnees = r"../applicationMasque/sortie/sortieT31TFJ"
repSortie = "sortie/sortieT31TFJ"

listeRep = os.listdir(repDonnees)


#ouvrir les TFE

TFEChemin = "TFE/tfe_bio_T31TFJ_WGS84.shp"    
TFE = gpd.read_file(TFEChemin) #ouverture du shp
   

listeCoordonnees = []
     
for j in range(len(TFE)):
    x = TFE.iloc[j].geometry.centroid.x #récupère les coordonnées d'un point
    y = TFE.iloc[j].geometry.centroid.y
     
    listeCoordonnees.append((x,y))    


legende = ["dates"]

for leg in range(len(TFE)):
    legende.append(TFE["Id_sitesAS"][leg])


tabCalcul = pd.DataFrame(columns = legende)




for i in range (len(listeRep)):
    repCourant = os.path.join(repDonnees, listeRep[i])#se positionner dans le répertoire d'une date
    
    nomParties = os.path.basename(listeRep[i]).split("_")
    date = nomParties[1]
    
    
    masque = os.path.join(repCourant,"masqueConverti.tiff")

    imageRef = gdal.Open(masque)
    cols = imageRef.RasterXSize
    rows = imageRef.RasterYSize
    transform = imageRef.GetGeoTransform()
    xOrigin = transform[0]
    yOrigin = transform[3]
    pixelWidth = transform[1]
    pixelHeight = -transform[5]
    
    index = 0
    
    for point in listeCoordonnees:
        col = int((point[0] - xOrigin) / pixelWidth)
        row = int((yOrigin - point[1] ) / pixelHeight)
    
        val = []
        val.append(masque[row][col])
                        
    concat = ind + val
        
    tab.loc[index]=concat
    
    index = index + 1